# アーキテクチャ設計書

## システム概要

Teaching Practice Showcaseは、教師が授業実践を共有し、学び合うためのWebアプリケーションです。
モダンなWeb技術スタックを使用し、スケーラブルで保守性の高いアーキテクチャを採用しています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                         クライアント層                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │   Desktop   │  │   Tablet    │  │   Mobile    │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────┬───────────────────────────────┘
                              │ HTTPS
┌─────────────────────────────┴───────────────────────────────┐
│                      フロントエンド層                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Next.js 14 (App Router)                 │   │
│  │  ┌─────────┐  ┌──────────┐  ┌────────────────┐   │   │
│  │  │  Pages   │  │Components│  │  Hooks/Utils   │   │   │
│  │  └─────────┘  └──────────┘  └────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────┘
                              │ REST API
┌─────────────────────────────┴───────────────────────────────┐
│                        バックエンド層                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               Express.js + TypeScript                │   │
│  │  ┌──────────┐  ┌────────────┐  ┌──────────────┐  │   │
│  │  │  Routes  │  │Controllers │  │ Middlewares  │  │   │
│  │  └──────────┘  └────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────┘
                              │ Prisma ORM
┌─────────────────────────────┴───────────────────────────────┐
│                      データベース層                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    PostgreSQL                        │   │
│  │  ┌─────────┐  ┌──────────┐  ┌────────────────┐   │   │
│  │  │  Users  │  │Practices │  │Comments/Ratings│   │   │
│  │  └─────────┘  └──────────┘  └────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 技術スタック詳細

### フロントエンド

#### Next.js 14 (App Router)
- **Server Components**: 初期ロードの高速化
- **Client Components**: インタラクティブなUI
- **ISR (Incremental Static Regeneration)**: パフォーマンス最適化
- **画像最適化**: next/imageによる自動最適化

#### 状態管理
- **React Hooks**: ローカル状態管理
- **Context API**: グローバル状態管理（認証状態など）
- **SWR/React Query**: サーバー状態管理（検討中）

#### スタイリング
- **Tailwind CSS**: ユーティリティファーストCSS
- **CSS Modules**: コンポーネント固有のスタイル
- **レスポンシブデザイン**: モバイルファースト

### バックエンド

#### Express.js
- **TypeScript**: 型安全性
- **RESTful API**: 標準的なHTTPメソッド
- **ミドルウェアアーキテクチャ**: 拡張性の高い設計

#### 認証・認可
- **JWT (JSON Web Token)**: ステートレス認証
- **bcrypt**: パスワードハッシュ化
- **ロールベースアクセス制御**: 管理者/一般ユーザー

#### データアクセス層
- **Prisma ORM**: 型安全なデータベースアクセス
- **マイグレーション管理**: スキーマのバージョン管理
- **シーディング**: 開発用データの投入

### データベース

#### PostgreSQL
- **リレーショナルモデル**: 正規化されたデータ構造
- **インデックス最適化**: クエリパフォーマンス
- **トランザクション**: データ整合性

#### スキーマ設計
```sql
-- 主要テーブル
Users (id, name, email, password, role, createdAt, updatedAt)
Practices (id, title, description, subject, gradeLevel, learningLevel, userId, ...)
Comments (id, content, practiceId, userId, createdAt, updatedAt)
Ratings (id, rating, practiceId, userId, createdAt, updatedAt)
Contacts (id, name, email, subject, message, practiceId, ...)
```

## セキュリティアーキテクチャ

### 認証フロー
```
1. ユーザーログイン
   └→ パスワード検証 (bcrypt)
      └→ JWT生成
         └→ クライアントに送信

2. APIリクエスト
   └→ JWTヘッダー検証
      └→ ユーザー情報取得
         └→ 権限チェック
            └→ リクエスト処理
```

### セキュリティ対策
- **HTTPS通信**: SSL/TLS暗号化
- **CORS設定**: オリジン制限
- **レート制限**: DDoS対策
- **入力検証**: XSS/SQLインジェクション対策
- **Helmet.js**: セキュリティヘッダー

## デプロイメントアーキテクチャ

### 開発環境
```
開発者PC
  ├─ フロントエンド (localhost:3000)
  ├─ バックエンド (localhost:5000)
  └─ PostgreSQL (localhost:5432)
```

### 本番環境
```
Vercel (フロントエンド)
  └─ CDN配信
     └─ エッジロケーション

Railway/Render (バックエンド)
  └─ コンテナ化されたアプリ
     └─ オートスケーリング

PostgreSQL (マネージドDB)
  └─ 自動バックアップ
     └─ レプリケーション
```

## パフォーマンス最適化

### フロントエンド
- **コード分割**: 動的インポート
- **画像最適化**: WebP変換、遅延読み込み
- **キャッシュ戦略**: ブラウザキャッシュ、CDN
- **バンドル最適化**: Tree shaking

### バックエンド
- **データベースクエリ最適化**: N+1問題の回避
- **キャッシュ**: Redis（将来実装）
- **非同期処理**: Promise/async-await
- **コネクションプーリング**: データベース接続

## スケーラビリティ

### 水平スケーリング
- **ステートレス設計**: セッション情報をJWTに
- **ロードバランシング**: 複数インスタンス対応
- **データベースレプリケーション**: 読み取り負荷分散

### 垂直スケーリング
- **リソース最適化**: メモリ/CPU使用率
- **データベースインデックス**: クエリ最適化
- **CDN活用**: 静的アセット配信

## 監視とロギング

### アプリケーション監視
- **ヘルスチェック**: /api/health
- **メトリクス収集**: レスポンスタイム、エラー率
- **アラート設定**: 異常検知

### ロギング戦略
- **構造化ログ**: JSON形式
- **ログレベル**: ERROR, WARN, INFO, DEBUG
- **ログ集約**: 中央管理（将来実装）

## 開発ワークフロー

### Git戦略
```
main (本番環境)
  └─ develop (開発環境)
      ├─ feature/xxx (機能開発)
      ├─ fix/xxx (バグ修正)
      └─ chore/xxx (その他)
```

### CI/CD パイプライン
1. **コード品質チェック**: ESLint, Prettier
2. **テスト実行**: Jest, React Testing Library
3. **ビルド**: TypeScriptコンパイル
4. **デプロイ**: 自動デプロイ

## 将来の拡張計画

### 機能拡張
- **リアルタイム通知**: WebSocket
- **ファイルストレージ**: AWS S3/Cloudinary
- **全文検索**: Elasticsearch
- **多言語対応**: i18n

### インフラ拡張
- **マイクロサービス化**: 機能別分離
- **API Gateway**: 統一エンドポイント
- **メッセージキュー**: 非同期処理
- **キャッシュレイヤー**: Redis