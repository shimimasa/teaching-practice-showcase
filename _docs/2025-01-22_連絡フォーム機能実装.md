# 2025-01-22 連絡フォーム機能実装

## 実施内容

### 1. メール送信機能 (`utils/email.ts`)
- Nodemailerを使用したメール送信設定
- SMTP設定（環境変数による設定）
- 教育者への新規連絡通知メールテンプレート
  - HTML形式とテキスト形式の両方に対応
  - 管理画面へのリンク付き

### 2. 連絡フォームのバリデーション (`middlewares/contactValidation.ts`)
- 必須フィールドの検証
  - 授業実践ID、保護者名、メールアドレス、子どもの年齢、メッセージ
- メールアドレス形式の検証
- 子どもの年齢範囲（6-15歳）の検証
- メッセージ文字数制限（2000文字）

### 3. 連絡管理API (`controllers/contactController.ts`)

#### 公開エンドポイント
- `POST /api/contacts` - 連絡フォーム送信
  - 授業実践の存在確認
  - 公開状態の確認
  - 教育者の連絡受付設定確認
  - メール通知の自動送信

#### 管理エンドポイント（認証必要）
- `GET /api/contacts` - 連絡一覧取得
  - 自分の授業実践への連絡のみ表示
  - ステータスフィルタ機能
  - ページネーション対応
  
- `GET /api/contacts/:id` - 連絡詳細取得
  - 権限チェック機能
  
- `PUT /api/contacts/:id/status` - ステータス更新
  - new（新規）、replied（返信済み）、closed（対応完了）

## 実装のポイント

### セキュリティ対策
- 教育者の連絡受付設定を確認
- 非公開授業への連絡を防止
- 自分宛の連絡のみアクセス可能

### エラーハンドリング
- メール送信失敗時でも連絡は保存
- 詳細なエラーメッセージ

### ユーザビリティ
- 保護者に分かりやすいメッセージ
- 教育者への即時メール通知

## APIエンドポイント一覧（更新）
```
連絡関連:
POST   /api/contacts          - 連絡送信（公開）
GET    /api/contacts          - 連絡一覧（要認証）
GET    /api/contacts/:id      - 連絡詳細（要認証）
PUT    /api/contacts/:id/status - ステータス更新（要認証）
```

## 次のステップ
- コメント・評価機能の実装
- ファイルアップロード機能
- フロントエンド共通コンポーネントの作成